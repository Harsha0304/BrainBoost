{% extends 'base.html' %}
{% block content %}

<style>
:root {
    --bg: #f8f9fa;
    --text: #212529;
    --card: #ffffff;
}
[data-theme="dark"] {
    --bg: #121212;
    --text: #f1f1f1;
    --card: #1e1e1e;
}
body {
    background: var(--bg);
    color: var(--text);
}

.card-box {
    background: var(--card);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    transition: transform 0.3s ease;
}
.card-box:hover {
    transform: translateY(-6px);
}

.theme-toggle {
    cursor: pointer;
}
</style>

<!-- HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>üìä Dashboard</h2>

    <div class="d-flex align-items-center gap-3">
        <span id="clock"></span>

        {% if request.user.is_authenticated and request.user.is_superuser %}
            <a href="{% url 'pending_user_approvals' %}"
               class="btn btn-sm btn-outline-warning">
                üõÇ Approvals
            </a>
        {% endif %}

        <button class="btn btn-sm btn-outline-secondary theme-toggle"
                onclick="toggleTheme()">
            üåó Theme
        </button>
    </div>
</div>

<!-- QUICK ACTION -->
<div class="mb-4">
    <a href="{% url 'courses' %}" class="btn btn-primary">
        üìö View All Courses
    </a>
</div>

<!-- STATS -->
<div class="row g-4">
    <div class="col-md-3">
        <div class="card-box">
            <h6>Courses Enrolled</h6>
            <h2>{{ enrolled_count }}</h2>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card-box">
            <h6>Lessons Completed</h6>
            <h2>{{ completed_lessons }} / {{ total_lessons }}</h2>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card-box">
            <h6>Overall Progress</h6>
            <h2>{{ progress }}%</h2>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card-box">
            <h6>Total Time Spent</h6>
            <h2>{{ time_spent_minutes }} min</h2>
        </div>
    </div>
</div>

<!-- ENROLLED COURSES -->
<h4 class="mt-5">üìö Enrolled Courses</h4>
<ul class="list-group">
{% for course in enrolled_courses %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{ course.title }}</span>
        <a href="{% url 'course_detail' course.id %}"
           class="btn btn-sm btn-outline-primary">
            Open
        </a>
    </li>
{% empty %}
    <li class="list-group-item">
        Not enrolled in any course yet.
        <a href="{% url 'courses' %}">Browse Courses</a>
    </li>
{% endfor %}
</ul>

<!-- LAST 7 DAYS GRAPH -->
<h4 class="mt-5">‚è± Time Spent (Last 7 Days)</h4>
<div class="card-box mt-3">
    <canvas id="timeSpentChart" height="140"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* LIVE CLOCK */
setInterval(() => {
    document.getElementById("clock").innerText =
        new Date().toLocaleString();
}, 1000);

/* THEME TOGGLE */
function toggleTheme() {
    const theme =
        document.body.getAttribute("data-theme") === "dark"
            ? "light"
            : "dark";
    document.body.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
}
document.body.setAttribute(
    "data-theme",
    localStorage.getItem("theme") || "light"
);

/* LAST 7 DAYS TIME SPENT GRAPH */
new Chart(document.getElementById('timeSpentChart'), {
    type: 'bar',
    data: {
        labels: {{ daily_labels|safe }},
        datasets: [{
            label: 'Minutes Spent',
            data: {{ daily_values|safe }},
            backgroundColor: '#0d6efd',
            borderRadius: 8,
            minBarLength: 10
        }]
    },
    options: {
        responsive: true,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(ctx) {
                        return ctx.parsed.y + ' minutes';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
                title: {
                    display: true,
                    text: 'Minutes'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Last 7 Days'
                }
            }
        }
    }
});
</script>

{% endblock %}
