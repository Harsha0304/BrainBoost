{% extends 'base.html' %}
{% block content %}

<h2>{{ lesson.title }}</h2>

<div class="card mt-3 mb-3">
    <div class="card-body">
        <p>{{ lesson.content|linebreaks }}</p>
    </div>
</div>
{% if lesson.content_type == 'PDF' %}
    <embed
        src="{{ lesson.pdf_file.url }}"
        type="application/pdf"
        width="100%"
        height="600px">
{% endif %}

{% if lesson.content_type == 'VIDEO' %}
    <video
        id="lessonVideo"
        width="100%"
        controls
        controlsList="nodownload noplaybackrate"
        disablePictureInPicture>
        <source src="{{ lesson.video_file.url }}" type="video/mp4">
    </video>

    {% if progress.completed %}
        <div class="alert alert-success mt-3">
            ✅ Lesson completed
        </div>
    {% else %}
        <div class="alert alert-info mt-3">
            ▶ Watch the full video to complete this lesson
        </div>
    {% endif %}
{% endif %}

<!-- =========================
     LESSON COMPLETION STATUS
========================= -->
{% if progress.completed %}
    <div class="alert alert-success mt-3">
        ✅ You have completed this lesson
    </div>
{% else %}
    <form method="post" class="mt-3">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">
            ✔ Mark as Completed
        </button>
    </form>
{% endif %}

<a href="{% url 'course_detail' lesson.course.id %}"
   class="btn btn-secondary mt-3">
    ⬅ Back to Course
</a>
<script>
const video = document.getElementById("lessonVideo");
let completed = {{ progress.completed|yesno:"true,false" }};
let lastTime = 0;

if (video && !completed) {

    // ❌ Disable seeking
    video.addEventListener("seeking", () => {
        video.currentTime = lastTime;
    });

    video.addEventListener("timeupdate", () => {
        lastTime = video.currentTime;
    });

    // ❌ Pause on tab switch
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            video.pause();
        }
    });

    // ❌ Pause on window blur
    window.addEventListener("blur", () => {
        video.pause();
    });

    // ✅ When video ends → mark complete
    video.addEventListener("ended", () => {
        fetch("{% url 'complete_lesson' lesson.id %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}"
            }
        }).then(() => {
            location.reload();
        });
    });
}
</script>

{% endblock %}
