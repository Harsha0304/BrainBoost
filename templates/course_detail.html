{% extends 'base.html' %}
{% block content %}

<style>
    .lesson-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .lesson-badge {
        font-size: 12px;
    }
    .quiz-result {
        font-size: 14px;
        font-weight: 600;
        color: #0d6efd;
    }
</style>

<h2>{{ course.title }}</h2>
<p>{{ course.description }}</p>

<!-- =========================
     COURSE COMPLETION
========================= -->
{% if course_completed %}
<div class="alert alert-success d-flex justify-content-between align-items-center">
    <span>ğŸ“ You have successfully completed this course!</span>
    <a href="{% url 'download_certificate' course.id %}"
       class="btn btn-sm btn-outline-success">
        ğŸ“„ Download Certificate
    </a>
</div>
{% endif %}

<!-- =========================
     ADMIN ACTIONS
========================= -->
{% if user.role == 'ADMIN' %}
<div class="mb-3">
    <a href="{% url 'add_lesson' course.id %}" class="btn btn-success">
        â• Add Lesson
    </a>
</div>
{% endif %}

<hr>

<h4>Lessons</h4>

<ul class="list-group">

{% for lesson in lessons %}
<li class="list-group-item d-flex justify-content-between align-items-center">

    <span>
        <strong>{{ lesson.order }}.</strong>
        {{ lesson.title }}

        {% if not lesson.is_active %}
            <span class="badge bg-secondary lesson-badge">Inactive</span>
        {% endif %}
    </span>

    <div class="lesson-actions">

        <!-- OPEN LESSON -->
        <a href="{% url 'lesson_detail' lesson.id %}"
           class="btn btn-sm btn-outline-primary">
            ğŸ“˜ Open
        </a>

        <!-- ADMIN QUIZ CONTROLS -->
        {% if user.role == 'ADMIN' %}
            {% if lesson.quiz %}
                <a href="{% url 'add_question' lesson.quiz.id %}"
                   class="btn btn-sm btn-outline-warning">
                    ğŸ§  Manage Quiz
                </a>
            {% else %}
                <a href="{% url 'create_quiz' lesson.id %}"
                   class="btn btn-sm btn-outline-success">
                    â• Create Quiz
                </a>
            {% endif %}
        {% endif %}

        <!-- STUDENT QUIZ LOGIC -->
        {% if user.role != 'ADMIN' and lesson.quiz %}

            {% if lesson.id in quiz_results %}
                {% with result=quiz_results|dictsort:"0" %}
                {% endwith %}
                <span class="quiz-result">
                    ğŸ“Š Score:
                    {{ quiz_results[lesson.id].score }}
                    /
                    {{ quiz_results[lesson.id].total_questions }}
                    ({{ quiz_results[lesson.id].percentage }}%)
                </span>
            {% else %}
                <a href="{% url 'take_quiz' lesson.quiz.id %}"
                   class="btn btn-sm btn-outline-success">
                    ğŸ“ Take Quiz
                </a>
            {% endif %}

        {% endif %}

    </div>

</li>
{% empty %}
<li class="list-group-item">
    No lessons added yet.
</li>
{% endfor %}

</ul>

<a href="{% url 'courses' %}" class="btn btn-secondary mt-4">
    â¬… Back to Courses
</a>

{% endblock %}
