{% extends 'base.html' %}
{% block content %}

<style>
    .lesson-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .lesson-badge {
        font-size: 12px;
    }
</style>

<h2>{{ course.title }}</h2>
<p>{{ course.description }}</p>

<!-- =========================
     ADMIN ACTIONS (COURSE)
========================= -->
{% if user.role == 'ADMIN' %}
<div class="mb-3 d-flex gap-2 flex-wrap">
    <a href="{% url 'add_lesson' course.id %}" class="btn btn-success">
        ‚ûï Add Lesson
    </a>

    {% if course.is_active %}
    <form method="post" action="{% url 'toggle_course' course.id %}">
        {% csrf_token %}
        <button class="btn btn-outline-danger">
            Deactivate Course
        </button>
    </form>
    {% else %}
    <form method="post" action="{% url 'toggle_course' course.id %}">
        {% csrf_token %}
        <button class="btn btn-outline-success">
            Activate Course
        </button>
    </form>
    {% endif %}
</div>
{% endif %}

<!-- =========================
     ENROLL STATUS (STUDENT)
========================= -->
{% if user.role != 'ADMIN' %}
    {% if not enrolled %}
        <a href="{% url 'enroll_course' course.id %}" class="btn btn-primary mb-3">
            üìò Enroll in Course
        </a>
    {% else %}
        <div class="alert alert-success mb-3">
            ‚úÖ You are enrolled in this course
        </div>
    {% endif %}
{% endif %}

<hr>

<h4>Lessons</h4>

<ul class="list-group">

{% if enrolled or user.role == 'ADMIN' %}
{% for lesson in lessons %}
<li class="list-group-item d-flex justify-content-between align-items-center">

    <span>
        <strong>{{ lesson.order }}.</strong>
        {{ lesson.title }}

        {% if not lesson.is_active %}
            <span class="badge bg-secondary lesson-badge">
                Inactive
            </span>
        {% endif %}
    </span>

    <div class="lesson-actions">

        <!-- =========================
             ADMIN CONTROLS
        ========================= -->
        {% if user.role == 'ADMIN' %}

            <a href="{% url 'edit_lesson' lesson.id %}"
               class="btn btn-sm btn-outline-secondary">
                ‚úè Edit
            </a>

            {% if lesson.is_active %}
                <form method="post" action="{% url 'toggle_lesson' lesson.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger">
                        Deactivate
                    </button>
                </form>
            {% else %}
                <form method="post" action="{% url 'toggle_lesson' lesson.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-success">
                        Activate
                    </button>
                </form>
            {% endif %}

            {% if lesson.quiz %}
                <a href="{% url 'add_question' lesson.quiz.id %}"
                   class="btn btn-sm btn-outline-warning">
                    üß† Manage Quiz
                </a>
            {% else %}
                <a href="{% url 'create_quiz' lesson.id %}"
                   class="btn btn-sm btn-outline-success">
                    ‚ûï Create Quiz
                </a>
            {% endif %}

        {% else %}
        <!-- =========================
             STUDENT CONTROLS
        ========================= -->

            <a href="{% url 'lesson_detail' lesson.id %}"
               class="btn btn-sm btn-outline-primary">
                üìò Open
            </a>

            {% if lesson.quiz %}
                {% with quiz_results.lesson.id as result %}
                {% endwith %}

                {% if quiz_results %}
                    {% for lid, result in quiz_results.items %}
                        {% if lid == lesson.id and result %}
                            <span class="badge bg-info">
                                üìä {{ result.score }}/{{ result.total_questions }}
                                ({{ result.percentage }}%)
                            </span>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if not quiz_results or not quiz_results.lesson.id %}
                    <a href="{% url 'take_quiz' lesson.quiz.id %}"
                       class="btn btn-sm btn-outline-success">
                        üìù Take Quiz
                    </a>
                {% endif %}
            {% endif %}

        {% endif %}

    </div>

</li>
{% empty %}
<li class="list-group-item">
    No lessons added yet.
</li>
{% endfor %}
{% else %}
<li class="list-group-item text-muted">
    üîí Enroll in this course to access lessons.
</li>
{% endif %}

</ul>

<a href="{% url 'courses' %}" class="btn btn-secondary mt-4">
    ‚¨Ö Back to Courses
</a>

{% endblock %}
